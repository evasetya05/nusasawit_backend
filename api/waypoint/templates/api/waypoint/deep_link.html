<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Buka Waypoint di NusaSawit</title>
    <meta property="og:title" content="Waypoint NusaSawit" />
    <meta property="og:description" content="Buka waypoint ini di aplikasi NusaSawit." />
    <meta property="og:url" content="{{ request.build_absolute_uri }}" />
    <meta property="og:type" content="website" />

    <style>
        :root {
            color-scheme: light;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            padding: 24px;
            font-family: "Poppins", "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #f0f7ff, #f5f5f5);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .card {
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 20px 45px rgba(15, 66, 146, 0.15);
            max-width: 420px;
            width: 100%;
            padding: 32px;
            text-align: center;
        }
        .logo-circle {
            width: 96px;
            height: 96px;
            border-radius: 28px;
            margin: 0 auto 24px;
            display: grid;
            place-items: center;
            font-weight: 700;
            letter-spacing: 2px;
            color: #fff;
            background: conic-gradient(from 180deg at 50% 50%, #00a859, #0f4292);
            font-size: 22px;
        }
        h1 {
            margin: 0 0 12px;
            color: #0f4292;
            font-size: 26px;
        }
        p {
            color: #5f6368;
            font-size: 16px;
            line-height: 1.6;
            margin: 0 0 16px;
        }
        .cta-button {
            background: linear-gradient(120deg, #0f4292, #00a859);
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 16px;
            width: 100%;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 12px 24px rgba(15, 66, 146, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 30px rgba(15, 66, 146, 0.3);
        }
        .countdown {
            margin-top: 24px;
            font-weight: 600;
            color: #00a859;
        }
        .note {
            margin-top: 16px;
            color: #9aa0a6;
            font-size: 14px;
        }
        .payload {
            margin-top: 20px;
            padding: 12px;
            font-family: "Fira Code", monospace;
            font-size: 13px;
            color: #3c4043;
            background: #f6f9fc;
            border-radius: 10px;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="logo-circle">NS</div>
        <h1>Buka Waypoint</h1>
        <p>Waypoint akan mencoba dibuka di aplikasi NusaSawit pada perangkat ini.</p>

        {% if waypoint %}
            <div class="payload">{{ waypoint }}</div>
        {% endif %}

        <button class="cta-button" onclick="openApp()">Buka di Aplikasi</button>
        <div class="countdown" id="countdown"></div>
        <div class="note">
            Jika aplikasi tidak terbuka secara otomatis, pastikan aplikasi NusaSawit sudah terpasang.
        </div>
    </div>

    {% if debug_mode %}
        <div class="card" style="margin-top: 24px; text-align: left;">
            <h2 style="margin-bottom: 12px; color: #0f4292;">Debug Information</h2>
            <pre style="background: #0f172a; color: #e2e8f0; padding: 16px; border-radius: 8px; overflow-x: auto;">
Deep Link URL : {{ deep_link_url }}
Fallback URL  : {{ fallback_url }}
Request HTTPS : {{ debug_info.request_is_secure }}
Scheme        : {{ debug_info.request_scheme }}
Host          : {{ debug_info.host }}
Path          : {{ debug_info.path }}
User-Agent    : {{ debug_info.user_agent }}
Referer       : {{ debug_info.referer }}
Waypoint param: {{ debug_info.waypoint_present }}
            </pre>
            <p style="font-size: 13px; color: #64748b; margin-top: 8px;">
                Debug aktif karena parameter <code>?debug=1</code> ada pada URL ini. Hapus parameter tersebut untuk kembali ke tampilan normal.
            </p>
        </div>
    {% endif %}

    <script>
        const deepLink = "{{ deep_link_url|escapejs }}";
        const fallbackUrl = "{{ fallback_url|escapejs }}";
        const countdownEl = document.getElementById("countdown");
        let seconds = 3;

        function tick() {
            if (seconds > 0) {
                countdownEl.textContent = `Membuka aplikasi dalam ${seconds} detik...`;
                seconds -= 1;
                setTimeout(tick, 1000);
            } else {
                countdownEl.textContent = "Menghubungkan ke aplikasi...";
                openApp();
            }
        }

        function openApp() {
            const isHttps = window.location.protocol === "https:";

            if (isHttps) {
                const appWindow = window.open(deepLink, "_blank");
                setTimeout(() => {
                    if (appWindow && !appWindow.closed) {
                        appWindow.close();
                    }
                    window.location.href = fallbackUrl;
                }, 1500);
            } else {
                window.location.href = deepLink;
                setTimeout(() => {
                    window.location.href = fallbackUrl;
                }, 2000);
            }
        }

        tick();
        setTimeout(openApp, 400);
    </script>
</body>
</html>

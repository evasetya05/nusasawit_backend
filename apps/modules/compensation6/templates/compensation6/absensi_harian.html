{% extends 'dashboard/base.html' %}
{% block content %}

<div class="container" style="max-width:900px;margin:auto;padding:20px;">
  <h2 style="text-align:center;margin-bottom:20px;">Absensi Harian</h2>

  <!-- Form Clock In/Out -->
  <div style="background:#fff;border:1px solid #eee;border-radius:10px;padding:20px;margin-bottom:30px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
    <h4>Catat Absensi</h4>
    <form method="post">
      {% csrf_token %}
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;">
        <div>{{ form.employee.label }}: {{ form.employee }}</div>
        <div>{{ form.date.label }}: {{ form.date }}</div>
        <div>{{ form.status.label }}: {{ form.status }}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px;">
        <div>{{ form.clock_in.label }}: {{ form.clock_in }}</div>
        <div>{{ form.clock_out.label }}: {{ form.clock_out }}</div>
      </div>
      <div style="margin-top:15px;padding:15px;background:#f0f8ff;border-radius:6px;border-left:4px solid #2563eb;">
        <h5 style="margin-top:0;color:#2563eb;">Borongan (Opsional)</h5>
        <p style="font-size:0.9em;color:#666;margin:5px 0 10px 0;">Pilih pekerjaan borongan dan masukkan realisasinya</p>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:15px;">
          <div>
            <label class="form-label">Pekerjaan Borongan:</label>
            <select name="borongan" class="form-control" id="id_borongan" style="width:100%;">
              <option value="">--- Pilih Borongan ---</option>
              {% for borongan in borongan_options %}
                <option value="{{ borongan.id }}" data-satuan="{{ borongan.satuan }}" data-harga="{{ borongan.harga_borongan }}">
                  {{ borongan.pekerjaan }} ({{ borongan.satuan }}) - Rp {{ borongan.harga_borongan }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="form-label">Realisasi (Satuan):</label>
            {{ form.realisasi }}
          </div>
        </div>
        <div style="margin-top:10px;padding:10px;background:#fff;border-radius:4px;border:1px solid #ddd;">
          <small style="color:#666;">
            <strong>Info Borongan:</strong> Satuan: <span id="satuan-display">-</span> | Harga: Rp <span id="harga-display">0</span> | Hasil Akhir: Rp <span id="hasil-akhir">0</span>
          </small>
        </div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const boronganSelect = document.getElementById('id_borongan');
          const realisasiInput = document.querySelector('input[name="realisasi"]');
          
          function updateBoronganInfo() {
            const selectedOption = boronganSelect.options[boronganSelect.selectedIndex];
            const satuan = selectedOption.dataset.satuan || '-';
            const harga = parseFloat(selectedOption.dataset.harga || '0');
            const realisasi = parseFloat(realisasiInput.value || '0');
            const hasilAkhir = realisasi * harga;
            
            document.getElementById('satuan-display').textContent = satuan;
            document.getElementById('harga-display').textContent = harga.toLocaleString('id-ID');
            document.getElementById('hasil-akhir').textContent = hasilAkhir.toLocaleString('id-ID', {minimumFractionDigits: 2, maximumFractionDigits: 2});
          }
          
          boronganSelect.addEventListener('change', updateBoronganInfo);
          realisasiInput.addEventListener('input', updateBoronganInfo);
          
          updateBoronganInfo();
        });
      </script>
      <div style="margin-top:15px;">{{ form.notes.label }}: {{ form.notes }}</div>
      <button type="submit" style="margin-top:15px;padding:10px 20px;background:#2563eb;color:#fff;border:0;border-radius:6px;">Simpan Absensi</button>
    </form>
  </div>

  <!-- List Absensi -->
  <div style="background:#fff;border:1px solid #eee;border-radius:10px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
    <h4>Riwayat Absensi</h4>
    {% if attendances %}
      <table style="width:100%;border-collapse:collapse;font-size:0.9em;">
        <thead>
          <tr style="background:#f8f9fa;">
            <th style="border:1px solid #ddd;padding:8px;">Tanggal</th>
            <th style="border:1px solid #ddd;padding:8px;">Karyawan</th>
            <th style="border:1px solid #ddd;padding:8px;">Clock In</th>
            <th style="border:1px solid #ddd;padding:8px;">Clock Out</th>
            <th style="border:1px solid #ddd;padding:8px;">Status</th>
            <th style="border:1px solid #ddd;padding:8px;">Borongan</th>
            <th style="border:1px solid #ddd;padding:8px;">Realisasi</th>
            <th style="border:1px solid #ddd;padding:8px;">Harga</th>
            <th style="border:1px solid #ddd;padding:8px;">Hasil Akhir</th>
            <th style="border:1px solid #ddd;padding:8px;">Catatan</th>
          </tr>
        </thead>
        <tbody>
          {% for a in attendances %}
          <tr>
            <td style="border:1px solid #ddd;padding:8px;">{{ a.date }}</td>
            <td style="border:1px solid #ddd;padding:8px;">{{ a.employee }}</td>
            <td style="border:1px solid #ddd;padding:8px;">{{ a.clock_in|default:'-' }}</td>
            <td style="border:1px solid #ddd;padding:8px;">{{ a.clock_out|default:'-' }}</td>
            <td style="border:1px solid #ddd;padding:8px;">{{ a.get_status_display }}</td>
            <td style="border:1px solid #ddd;padding:8px;">
              {% if a.borongan %}
                <strong>{{ a.borongan.pekerjaan }}</strong><br><small style="color:#666;">({{ a.borongan.satuan }})</small>
              {% else %}
                -
              {% endif %}
            </td>
            <td style="border:1px solid #ddd;padding:8px;text-align:center;">
              {% if a.borongan %}
                {{ a.realisasi }}
              {% else %}
                -
              {% endif %}
            </td>
            <td style="border:1px solid #ddd;padding:8px;text-align:right;">
              {% if a.borongan %}
                Rp {{ a.borongan.harga_borongan }}
              {% else %}
                -
              {% endif %}
            </td>
            <td style="border:1px solid #ddd;padding:8px;text-align:right;font-weight:bold;background:#f0f8ff;">
              {% if a.borongan and a.realisasi %}
                Rp {{ a.get_hasil_akhir }}
              {% else %}
                -
              {% endif %}
            </td>
            <td style="border:1px solid #ddd;padding:8px;">{{ a.notes|default:'-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>Belum ada data absensi.</p>
    {% endif %}
  </div>

  <div style="text-align:center;margin-top:30px;">
    <a href="{% url 'compensation6:komponen_gaji' %}" style="display:inline-block;background:#6c757d;color:white;padding:10px 20px;border-radius:6px;text-decoration:none;">
      ‚Üê Kembali ke Komponen Gaji
    </a>
  </div>
</div>
{% endblock %}

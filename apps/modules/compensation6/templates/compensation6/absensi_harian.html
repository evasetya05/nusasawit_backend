{% extends 'dashboard/base.html' %}
{% load humanize %}
{% block content %}

<div class="container" style="max-width:900px;margin:auto;padding:20px;">
  <h2 style="text-align:center;margin-bottom:20px;">Absensi Harian</h2>

  <!-- Debug Info Panel -->
  <div class="alert alert-info" style="margin-bottom:20px;">
    <h5>Debug Information</h5>
    <ul style="margin-bottom:0;">
      <li><strong>User:</strong> {{ debug_info.user.username }} (ID: {{ debug_info.user.id }})</li>
      <li><strong>Is Owner:</strong> {{ debug_info.is_owner }}</li>
      <li><strong>Has Person:</strong> {{ debug_info.has_person }}</li>
      <li><strong>Is Employee:</strong> {{ debug_info.is_employee }}</li>
      <li><strong>Is Supervisor:</strong> {{ debug_info.is_supervisor }}</li>
      {% if debug_info.employee %}
      <li><strong>Employee:</strong> {{ debug_info.employee.name }} (ID: {{ debug_info.employee.id }})</li>
      <li><strong>Manager:</strong> {{ debug_info.manager|default:"None" }}</li>
      <li><strong>Subordinates (Employee):</strong>
        {% if debug_info.subordinates %}
        {% for sub in debug_info.subordinates %}{{ sub.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
        {% else %}
        None
        {% endif %}
      </li>
      {% endif %}
      <li><strong>Person Subordinates:</strong>
        {% if debug_info.person_subordinates %}
        {% for sub in debug_info.person_subordinates %}{{ sub.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
        {% else %}
        None
        {% endif %}
      </li>
    </ul>
  </div>

  <!-- Form Clock In/Out -->
  <div
    style="background:#fff;border:1px solid #eee;border-radius:10px;padding:20px;margin-bottom:30px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
    <h4>Catat Absensi</h4>
    <form method="post">
      {% csrf_token %}
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;">
        <div>{{ form.employee.label }}: {{ form.employee }}</div>
        <div>{{ form.date.label }}: {{ form.date }}</div>
        <div>{{ form.status.label }}: {{ form.status }}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px;">
        <div>{{ form.clock_in.label }}: {{ form.clock_in }}</div>
        <div>{{ form.clock_out.label }}: {{ form.clock_out }}</div>
      </div>
      <div style="margin-top:15px;padding:15px;background:#f0f8ff;border-radius:6px;border-left:4px solid #2563eb;">
        <h5 style="margin-top:0;color:#2563eb;">Borongan (Opsional)</h5>
        <p style="font-size:0.9em;color:#666;margin:5px 0 10px 0;">Pilih pekerjaan borongan dan masukkan realisasinya
        </p>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:15px;">
          <div>
            <label class="form-label">Pekerjaan Borongan:</label>
            <select name="borongan" class="form-control" id="id_borongan" style="width:100%;">
              <option value="">--- Pilih Borongan ---</option>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <div>
            <label class="form-label">Realisasi (Satuan):</label>
            {{ form.realisasi }}
          </div>
        </div>
        <div style="margin-top:10px;padding:10px;background:#fff;border-radius:4px;border:1px solid #ddd;">
          <small style="color:#666;">
            <strong>Info Borongan:</strong> Satuan: <span id="satuan-display">-</span> | Harga: Rp <span
              id="harga-display">0</span> | Hasil Akhir: Rp <span id="hasil-akhir">0</span>
          </small>
        </div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const employeeSelect = document.querySelector('select[name="employee"]');
          const boronganSelect = document.getElementById('id_borongan');
          const realisasiInput = document.querySelector('input[name="realisasi"]');

          // Function to update borongan options based on selected employee
          async function updateBoronganOptions() {
            const employeeId = employeeSelect.value;
            
            // Clear current options
            boronganSelect.innerHTML = '<option value="">--- Pilih Borongan ---</option>';
            
            if (!employeeId) {
              updateBoronganInfo();
              return;
            }
            
            try {
              const response = await fetch(`/compensation/api/get-borongan-by-employee/?employee_id=${employeeId}`);
              const data = await response.json();
              
              if (data.borongan_options) {
                data.borongan_options.forEach(borongan => {
                  const option = document.createElement('option');
                  option.value = borongan.id;
                  option.dataset.satuan = borongan.satuan;
                  option.dataset.harga = borongan.harga_borongan;
                  option.textContent = `${borongan.pekerjaan} (${borongan.satuan}) - Rp ${borongan.harga_borongan.toLocaleString('id-ID')}`;
                  boronganSelect.appendChild(option);
                });
              }
            } catch (error) {
              console.error('Error fetching borongan options:', error);
            }
            
            updateBoronganInfo();
          }

          function updateBoronganInfo() {
            const selectedOption = boronganSelect.options[boronganSelect.selectedIndex];
            const satuan = selectedOption.dataset.satuan || '-';
            const harga = parseFloat(selectedOption.dataset.harga || '0');
            const realisasi = parseFloat(realisasiInput.value || '0');
            const hasilAkhir = realisasi * harga;

            document.getElementById('satuan-display').textContent = satuan;
            document.getElementById('harga-display').textContent = harga.toLocaleString('id-ID');
            document.getElementById('hasil-akhir').textContent = hasilAkhir.toLocaleString('id-ID', { maximumFractionDigits: 0 });
          }

          // Event listeners
          employeeSelect.addEventListener('change', updateBoronganOptions);
          boronganSelect.addEventListener('change', updateBoronganInfo);
          realisasiInput.addEventListener('input', updateBoronganInfo);

          // Initialize
          updateBoronganOptions();
        });
      </script>
      <div style="margin-top:15px;">{{ form.notes.label }}: {{ form.notes }}</div>
      <button type="submit"
        style="margin-top:15px;padding:10px 20px;background:#2563eb;color:#fff;border:0;border-radius:6px;">Simpan
        Absensi</button>
    </form>
  </div>

  <!-- List Absensi -->
  <div
    style="background:#fff;border:1px solid #eee;border-radius:10px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
    <h4>Riwayat Absensi</h4>
    {% if attendances %}
    <table style="width:100%;border-collapse:collapse;font-size:0.9em;">
      <thead>
        <tr style="background:#f8f9fa;">
          <th style="border:1px solid #ddd;padding:8px;">Tanggal</th>
          <th style="border:1px solid #ddd;padding:8px;">Karyawan</th>
          <th style="border:1px solid #ddd;padding:8px;">Clock In</th>
          <th style="border:1px solid #ddd;padding:8px;">Clock Out</th>
          <th style="border:1px solid #ddd;padding:8px;">Status</th>
          <th style="border:1px solid #ddd;padding:8px;">Borongan</th>
          <th style="border:1px solid #ddd;padding:8px;">Realisasi</th>
          <th style="border:1px solid #ddd;padding:8px;">Harga</th>
          <th style="border:1px solid #ddd;padding:8px;">Hasil Akhir</th>
          <th style="border:1px solid #ddd;padding:8px;">Catatan</th>
        </tr>
      </thead>
      <tbody>
        {% for a in attendances %}
        <tr>
          <td style="border:1px solid #ddd;padding:8px;">{{ a.date }}</td>
          <td style="border:1px solid #ddd;padding:8px;">{{ a.employee }}</td>
          <td style="border:1px solid #ddd;padding:8px;">{{ a.clock_in|default:'-' }}</td>
          <td style="border:1px solid #ddd;padding:8px;">{{ a.clock_out|default:'-' }}</td>
          <td style="border:1px solid #ddd;padding:8px;">{{ a.get_status_display }}</td>
          <td style="border:1px solid #ddd;padding:8px;">
            {% if a.borongan %}
            <strong>{{ a.borongan.pekerjaan }}</strong><br><small style="color:#666;">({{ a.borongan.satuan }})</small>
            {% else %}
            -
            {% endif %}
          </td>
          <td style="border:1px solid #ddd;padding:8px;text-align:center;">
            {% if a.borongan %}
            {{ a.realisasi|floatformat:0|intcomma }}
            {% else %}
            -
            {% endif %}
          </td>
          <td style="border:1px solid #ddd;padding:8px;text-align:right;">
            {% if a.borongan %}
            Rp {{ a.borongan.harga_borongan|floatformat:0|intcomma }}
            {% else %}
            -
            {% endif %}
          </td>
          <td style="border:1px solid #ddd;padding:8px;text-align:right;font-weight:bold;background:#f0f8ff;">
            {% if a.borongan and a.realisasi %}
            Rp {{ a.get_hasil_akhir|floatformat:0|intcomma }}
            {% else %}
            -
            {% endif %}
          </td>
          <td style="border:1px solid #ddd;padding:8px;">{{ a.notes|default:'-' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>Belum ada data absensi.</p>
    {% endif %}
  </div>

  <div style="text-align:center;margin-top:30px;">
    <a href="{% url 'compensation6:komponen_gaji' %}"
      style="display:inline-block;background:#6c757d;color:white;padding:10px 20px;border-radius:6px;text-decoration:none;">
      ‚Üê Kembali ke Komponen Gaji
    </a>
  </div>
</div>
{% endblock %}
{% extends 'dashboard/base.html' %}
{% load humanize %}
{% block content %}

<div class="container" style="max-width:900px;margin:auto;padding:20px;">
  <h2 style="text-align:center;margin-bottom:20px;">Absensi Harian</h2>

  <!-- Debug Info Panel -->
  <div class="alert alert-info" style="margin-bottom:20px;">
    <h5>Debug Information</h5>
    <ul style="margin-bottom:0;">
      <li><strong>User:</strong> {{ debug_info.user.username }} (ID: {{ debug_info.user.id }})</li>
      <li><strong>Is Owner:</strong> {{ debug_info.is_owner }}</li>
      <li><strong>Has Person:</strong> {{ debug_info.has_person }}</li>
      <li><strong>Is Employee:</strong> {{ debug_info.is_employee }}</li>
      <li><strong>Is Supervisor:</strong> {{ debug_info.is_supervisor }}</li>
      {% if debug_info.employee %}
      <li><strong>Employee:</strong> {{ debug_info.employee.name }} (ID: {{ debug_info.employee.id }})</li>
      <li><strong>Manager:</strong> {{ debug_info.manager|default:"None" }}</li>
      <li><strong>Subordinates (Employee):</strong>
        {% if debug_info.subordinates %}
        {% for sub in debug_info.subordinates %}{{ sub.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
        {% else %}
        None
        {% endif %}
      </li>
      {% endif %}
      <li><strong>Person Subordinates:</strong>
        {% if debug_info.person_subordinates %}
        {% for sub in debug_info.person_subordinates %}{{ sub.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
        {% else %}
        None
        {% endif %}
      </li>
    </ul>
  </div>

  <!-- Form Clock In/Out -->
  <div
    style="background:#fff;border:1px solid #eee;border-radius:10px;padding:20px;margin-bottom:30px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
    <h4>Catat Absensi</h4>
    <form method="post">
      {% csrf_token %}
      
      <!-- Display form errors -->
      {% if form.non_field_errors %}
      <div class="alert alert-danger" style="margin-bottom:15px;">
        <strong>Error:</strong>
        <ul style="margin-bottom:0;">
          {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      
      {% for field in form %}
        {% if field.errors %}
      <div class="alert alert-danger" style="margin-bottom:15px;">
        <strong>{{ field.label }}:</strong>
        <ul style="margin-bottom:0;">
          {% for error in field.errors %}
          <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
        {% endif %}
      {% endfor %}
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;">
        <div>{{ form.employee.label }}: {{ form.employee }}</div>
        <div>{{ form.date.label }}: {{ form.date }}</div>
        <div>{{ form.status.label }}: {{ form.status }}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px;">
        <div>{{ form.clock_in.label }}: {{ form.clock_in }}</div>
        <div>{{ form.clock_out.label }}: {{ form.clock_out }}</div>
      </div>
      <div style="margin-top:15px;padding:15px;background:#f0f8ff;border-radius:6px;border-left:4px solid #2563eb;">
        <h5 style="margin-top:0;color:#2563eb;">Borongan (Opsional)</h5>
        <p style="font-size:0.9em;color:#666;margin:5px 0 10px 0;">Pilih pekerjaan borongan dan masukkan realisasinya
        </p>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:15px;">
          <div>
            <label class="form-label">Pekerjaan Borongan:</label>
            {{ form.borongan }}
          </div>
          <div>
            <label class="form-label">Realisasi (Satuan):</label>
            {{ form.realisasi }}
          </div>
        </div>
        <div style="margin-top:10px;padding:10px;background:#fff;border-radius:4px;border:1px solid #ddd;">
          <small style="color:#666;">
            <strong>Info Borongan:</strong> Satuan: <span id="satuan-display">-</span> | Harga: Rp <span
              id="harga-display">0</span> | Hasil Akhir: Rp <span id="hasil-akhir">0</span>
          </small>
        </div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const employeeSelect = document.querySelector('select[name="employee"]');
          const boronganSelect = document.querySelector('select[name="borongan"]');
          const realisasiInput = document.querySelector('input[name="realisasi"]');

          // Function to update borongan options based on selected employee
          async function updateBoronganOptions() {
            const employeeId = employeeSelect.value;

            // Clear current options and add default option
            boronganSelect.innerHTML = '<option value="">--- Pilih Borongan ---</option>';

            if (!employeeId) {
              updateBoronganInfo();
              return;
            }

            try {
              const response = await fetch(`/compensation/api/get-borongan-by-employee/?employee_id=${employeeId}`);
              const data = await response.json();

              if (data.borongan_options) {
                data.borongan_options.forEach(borongan => {
                  const option = document.createElement('option');
                  option.value = borongan.id;
                  option.dataset.satuan = borongan.satuan;
                  option.dataset.harga = borongan.harga_borongan;
                  option.textContent = `${borongan.pekerjaan} (${borongan.satuan}) - Rp ${borongan.harga_borongan.toLocaleString('id-ID')}`;
                  boronganSelect.appendChild(option);
                });
              }
            } catch (error) {
              console.error('Error fetching borongan options:', error);
            }

            updateBoronganInfo();
          }

          function updateBoronganInfo() {
            const selectedOption = boronganSelect.options[boronganSelect.selectedIndex];
            const satuan = selectedOption.dataset.satuan || '-';
            const harga = parseFloat(selectedOption.dataset.harga || '0');
            const realisasi = parseFloat(realisasiInput.value || '0');
            const hasilAkhir = realisasi * harga;

            document.getElementById('satuan-display').textContent = satuan;
            document.getElementById('harga-display').textContent = harga.toLocaleString('id-ID');
            document.getElementById('hasil-akhir').textContent = hasilAkhir.toLocaleString('id-ID', { maximumFractionDigits: 0 });
          }

          // Event listeners
          employeeSelect.addEventListener('change', updateBoronganOptions);
          boronganSelect.addEventListener('change', updateBoronganInfo);
          realisasiInput.addEventListener('input', updateBoronganInfo);

          // Initialize
          updateBoronganOptions();
        });
      </script>
      <div style="margin-top:15px;">{{ form.notes.label }}: {{ form.notes }}</div>
      <button type="submit"
        style="margin-top:15px;padding:10px 20px;background:#2563eb;color:#fff;border:0;border-radius:6px;">Simpan
        Absensi</button>
    </form>
  </div>

  <!-- Link to Riwayat Absensi -->
  <div
    style="background:#fff;border:1px solid #eee;border-radius:10px;padding:30px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
    <h4 style="margin-bottom:15px;">Lihat Riwayat Absensi</h4>
    <p style="color:#666;margin-bottom:20px;">Klik tombol di bawah untuk melihat riwayat absensi lengkap dengan filter
    </p>
    <a href="{% url 'compensation6:riwayat_absensi' %}"
      style="display:inline-block;background:#2563eb;color:white;padding:12px 30px;border-radius:6px;text-decoration:none;font-weight:500;">
      <i class="fas fa-history"></i> Buka Riwayat Absensi
    </a>
  </div>


</div>
{% endblock %}
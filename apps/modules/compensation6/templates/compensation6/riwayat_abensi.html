{% extends 'dashboard/base.html' %}
{% load humanize %}
{% block content %}

<div class="container" style="max-width:1200px;margin:auto;padding:20px;">
  <h2 style="text-align:center;margin-bottom:20px;">Riwayat Absensi</h2>

  <!-- Filter Section -->
  <div style="background:#fff;border:1px solid #eee;border-radius:10px;padding:20px;margin-bottom:20px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
    <form method="GET" style="display:flex;gap:15px;align-items:end;flex-wrap:wrap;">
      <div style="flex:1;min-width:200px;">
        <label class="form-label fw-semibold">Karyawan</label>
        <select name="employee" class="form-select">
          <option value="">Semua Karyawan</option>
          {% for emp in available_employees %}
          <option value="{{ emp.id }}" {% if emp.id|stringformat:"s" == selected_employee_id %}selected{% endif %}>
            {{ emp.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div style="flex:0 0 120px;">
        <label class="form-label fw-semibold">Bulan</label>
        <select name="month" class="form-select">
          <option value="">Semua Bulan</option>
          {% for month in available_months %}
          <option value="{{ month }}" {% if month|stringformat:"s" == selected_month %}selected{% endif %}>
            {{ month|date:"F" }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div style="flex:0 0 100px;">
        <label class="form-label fw-semibold">Tahun</label>
        <select name="year" class="form-select">
          <option value="">Semua Tahun</option>
          {% for year in available_years %}
          <option value="{{ year }}" {% if year|stringformat:"s" == selected_year %}selected{% endif %}>
            {{ year }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      <div style="flex:0 0 auto;">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-filter"></i> Filter
        </button>
        <a href="{% url 'compensation6:riwayat_absensi' %}" class="btn btn-secondary">
          <i class="fas fa-times"></i> Reset
        </a>
      </div>
    </form>
  </div>

  <!-- Results Summary -->
  {% if selected_employee_id or selected_month or selected_year %}
  <div class="alert alert-info" style="margin-bottom:20px;">
    <strong>Filter Aktif:</strong>
    {% if selected_employee_id %}
      Karyawan: {% for emp in available_employees %}{% if emp.id|stringformat:"s" == selected_employee_id %}{{ emp.name }}{% endif %}{% endfor %}
    {% endif %}
    {% if selected_month %}
      Bulan: {{ selected_month|date:"F" }}
    {% endif %}
    {% if selected_year %}
      Tahun: {{ selected_year }}
    {% endif %}
    - <strong>{{ attendances.count }}</strong> data ditemukan
  </div>
  {% endif %}

  <div
    style="background:#fff;border:1px solid #eee;border-radius:10px;padding:20px;box-shadow:0 1px 4px rgba(0,0,0,0.04);">
    {% if attendances %}
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead>
          <tr style="background:#f8f9fa;">
            <th>Tanggal</th>
            <th>Karyawan</th>
            <th>Clock In</th>
            <th>Clock Out</th>
            <th>Status</th>
            <th>Borongan</th>
            <th>Realisasi</th>
            <th>Harga</th>
            <th>Hasil Akhir</th>
            <th>Catatan</th>
          </tr>
        </thead>
        <tbody>
          {% for a in attendances %}
          <tr>
            <td>{{ a.date }}</td>
            <td>{{ a.employee }}</td>
            <td>{{ a.clock_in|default:'-' }}</td>
            <td>{{ a.clock_out|default:'-' }}</td>
            <td>{{ a.get_status_display }}</td>
            <td>
              {% if a.borongan %}
              <strong>{{ a.borongan.pekerjaan }}</strong><br><small class="text-muted">({{ a.borongan.satuan }})</small>
              {% else %}
              -
              {% endif %}
            </td>
            <td class="text-center">
              {% if a.borongan %}
              {{ a.realisasi|floatformat:0|intcomma }}
              {% else %}
              -
              {% endif %}
            </td>
            <td class="text-right">
              {% if a.borongan %}
              Rp {{ a.borongan.harga_borongan|floatformat:0|intcomma }}
              {% else %}
              -
              {% endif %}
            </td>
            <td class="text-right font-weight-bold" style="background:#f0f8ff;">
              {% if a.borongan and a.realisasi %}
              Rp {{ a.get_hasil_akhir|floatformat:0|intcomma }}
              {% else %}
              -
              {% endif %}
            </td>
            <td>{{ a.notes|default:'-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-center">Belum ada data absensi.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
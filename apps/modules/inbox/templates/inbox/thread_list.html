{% extends 'dashboard/base.html' %}
{% load static widget_tweaks %}

{% block content %}
<div class="container-fluid" style="max-width: 1200px; margin: auto; padding: 20px;">
  <h2 class="mb-4">Inbox - Percakapan</h2>

  <!-- Start Thread Form (Admin Only) -->
  {% if thread_form %}
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Mulai Percakapan Baru</h5>
    </div>
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="start_thread">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="{{ thread_form.supervisor.id_for_label }}" class="form-label">Supervisor</label>
            {{ thread_form.supervisor|add_class:"form-select" }}
            {% if thread_form.supervisor.errors %}
              <div class="text-danger small">
                {% for error in thread_form.supervisor.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
          </div>
          <div class="col-md-6">
            <label for="{{ thread_form.subject.id_for_label }}" class="form-label">Subjek (Opsional)</label>
            {{ thread_form.subject|add_class:"form-control" }}
            {% if thread_form.subject.errors %}
              <div class="text-danger small">
                {% for error in thread_form.subject.errors %}{{ error }}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary">Mulai Percakapan</button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <div class="row">
    <!-- Threads List -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Percakapan</h5>
        </div>
        <div class="card-body p-0">
          {% if threads %}
            <div class="list-group list-group-flush">
              {% for thread in threads %}
                <a href="?thread={{ thread.id }}" 
                   class="list-group-item list-group-item-action {% if selected_thread and selected_thread.id == thread.id %}active{% endif %}">
                  <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">{{ thread.supervisor_display }}</h6>
                    <small class="text-muted">{{ thread.updated_at|date:"d M Y, H:i" }}</small>
                  </div>
                  {% if thread.subject %}
                    <p class="mb-1 small text-muted">{{ thread.subject }}</p>
                  {% endif %}
                </a>
              {% endfor %}
            </div>
          {% else %}
            <div class="p-3 text-center text-muted">
              Belum ada percakapan
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="col-md-8">
      {% if selected_thread %}
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0">
              Percakapan dengan {{ selected_thread.supervisor_display }}
              {% if selected_thread.subject %}
                <br><small class="text-muted">{{ selected_thread.subject }}</small>
              {% endif %}
            </h5>
          </div>
          <div class="card-body">
            <!-- Messages -->
            <div class="mb-3" style="max-height: 400px; overflow-y: auto;">
              {% for message in selected_thread.messages.all %}
                <div class="d-flex mb-3 {% if message.sender_admin %}justify-content-end{% else %}justify-content-start{% endif %}">
                  <div class="card {% if message.sender_admin %}bg-primary text-white{% else %}bg-light{% endif %}" 
                       style="max-width: 70%; {% if not message.sender_admin %}margin-left: 10px;{% endif %}">
                    <div class="card-body p-2">
                      <small class="d-block {% if message.sender_admin %}text-white-50{% else %}text-muted{% endif %}">
                        {{ message.sender_label }} â€¢ {{ message.created_at|date:"d M Y, H:i" }}
                      </small>
                      <div class="mt-1">{{ message.content|linebreaks }}</div>
                    </div>
                  </div>
                </div>
              {% empty %}
                <div class="text-center text-muted p-3">
                  Belum ada pesan dalam percakapan ini
                </div>
              {% endfor %}
            </div>

            <!-- Message Form -->
            <form method="post" class="mt-3">
              {% csrf_token %}
              <input type="hidden" name="action" value="send_message">
              <input type="hidden" name="thread_id" value="{{ selected_thread.id }}">
              <div class="input-group">
                {{ message_form.content|add_class:"form-control" }}
                <button class="btn btn-primary" type="submit">Kirim</button>
              </div>
              {% if message_form.content.errors %}
                <div class="text-danger small mt-1">
                  {% for error in message_form.content.errors %}{{ error }}{% endfor %}
                </div>
              {% endif %}
            </form>
          </div>
        </div>
      {% else %}
        <div class="card">
          <div class="card-body text-center text-muted">
            <i class="fas fa-comments fa-3x mb-3"></i>
            <h5>Pilih Percakapan</h5>
            <p>Pilih percakapan dari daftar di sebelah kiri untuk melihat dan mengirim pesan.</p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Auto-scroll to latest message -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const chatContainer = document.querySelector('[style*="max-height: 400px"]');
  if (chatContainer) {
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }
});
</script>
{% endblock %}
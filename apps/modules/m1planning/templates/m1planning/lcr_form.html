{% extends "dashboard/base.html" %}
{% load i18n crispy_forms_tags %}
{% block content %}
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
      {% if form.instance.pk %}
        {% trans "Update LCR Record" %}
      {% else %}
        {% trans "Create New LCR Record" %}
      {% endif %}
    </h1>
  </div>
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow">
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            <div class="row mb-4">
              <div class="col-12">
                <h5 class="mb-4">{% trans "Record Information" %}</h5>
                {{ form.period|as_crispy_field }}
                {{ form.total_income|as_crispy_field }}
                {{ form.total_labor_cost|as_crispy_field }}
                <!-- LCR Preview -->
                <div class="card text-bg-light mb-4">
                  <div class="card-body">
                    <h6 class="card-title">{% trans "LCR Preview" %}</h6>
                    <div class="row">
                      <div class="col-md-6">
                        <p class="mb-1 text-secondary">{% trans "Labor Cost Ratio" %}</p>
                        <h3 id="lcr-preview">-</h3>
                      </div>
                      <div class="col-md-6">
                        <div class="progress mt-3" style="height: 30px;">
                          <div id="lcr-progress"
                               class="progress-bar bg-success"
                               role="progressbar"
                               style="width: 0%"
                               aria-valuenow="0"
                               aria-valuemin="0"
                               aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                          <small>0%</small>
                          <small>100%</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="d-flex justify-content-between">
              <a href="{% if form.instance.pk %}{% url 'm1planning:list' %}{% else %}{% url 'm1planning:dashboard' %}{% endif %}"
                 class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                {% trans "Cancel" %}
              </a>
              <div class="btn-group">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save me-1"></i>
                  {% if form.instance.pk %}
                    {% trans 'Update Record' %}
                  {% else %}
                    {% trans 'Create Record' %}
                  {% endif %}
                </button>
                {% if form.instance.pk %}
                  <a href="{% url 'm1planning:delete' form.instance.pk %}"
                     class="btn btn-outline-danger">
                    <i class="fas fa-trash me-1"></i>
                    {% trans 'Delete' %}
                  </a>
                {% endif %}
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block extra_js %}
  {{ block.super }}
  <script>
document.addEventListener('DOMContentLoaded', function() {
    // Format number inputs with thousand separators
    function formatNumberInput(input) {
        if (input.value) {
            const value = input.value.replace(/\D/g, '');
            input.value = value ? Number(value).toLocaleString('id-ID') : '';

            // Update the hidden field with the raw value
            const hiddenInput = document.getElementById(input.id + '_hidden');
            if (hiddenInput) {
                hiddenInput.value = value;
            }

            // Update LCR preview
            updateLCRPreview();
        }
    }

    // Update LCR preview
    function updateLCRPreview() {
        const incomeInput = document.getElementById('id_total_income');
        const costInput = document.getElementById('id_total_labor_cost');
        const lcrPreview = document.getElementById('lcr-preview');
        const lcrProgress = document.getElementById('lcr-progress');

        try {
            const income = parseInt(incomeInput.value.replace(/\./g, '')) || 0;
            const cost = parseInt(costInput.value.replace(/\./g, '')) || 0;

            if (income > 0) {
                const lcr = (cost / income) * 100;
                lcrPreview.textContent = lcr.toFixed(2) + '%';

                // Update progress bar
                const percentage = Math.min(Math.round(lcr), 100);
                lcrProgress.style.width = percentage + '%';

                // Update progress bar color based on LCR value
                if (lcr <= 20) {
                    lcrProgress.className = 'progress-bar bg-warning';
                } else if (lcr <= 60) {
                    lcrProgress.className = 'progress-bar bg-success';
                } else if (lcr <= 80) {
                    lcrProgress.className = 'progress-bar bg-warning';
                } else {
                    lcrProgress.className = 'progress-bar bg-danger';
                }

                lcrProgress.setAttribute('aria-valuenow', percentage);
            } else {
                lcrPreview.textContent = '-';
                lcrProgress.style.width = '0%';
                lcrProgress.className = 'progress-bar';
                lcrProgress.setAttribute('aria-valuenow', '0');
            }
        } catch (e) {
            console.error('Error calculating LCR:', e);
            lcrPreview.textContent = '-';
        }
    }

    // Add event listeners to number inputs
    const numberInputs = document.querySelectorAll('input[type="number"]');
    numberInputs.forEach(function(input) {
        // Create hidden input to store raw value
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.id = input.id + '_hidden';
        hiddenInput.name = input.name;
        hiddenInput.value = input.value;

        // Replace original input with text input for better formatting
        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.className = input.className;
        textInput.id = input.id;
        textInput.placeholder = input.placeholder;
        textInput.value = input.value ? Number(input.value).toLocaleString('id-ID') : '';

        // Copy all attributes
        for (let i = 0; i < input.attributes.length; i++) {
            const attr = input.attributes[i];
            if (attr.name !== 'type' && attr.name !== 'value' && attr.name !== 'id' && attr.name !== 'class' && attr.name !== 'name') {
                textInput.setAttribute(attr.name, attr.value);
            }
        }

        // Replace the original input
        input.parentNode.insertBefore(hiddenInput, input);
        input.parentNode.replaceChild(textInput, input);

        // Add event listeners
        textInput.addEventListener('blur', function() {
            formatNumberInput(this);
        });

        textInput.addEventListener('input', function() {
            updateLCRPreview();
        });

        // Format on page load
        formatNumberInput(textInput);
    });

    // Initialize date picker for period field
    const periodInput = document.getElementById('id_period');
    if (periodInput) {
        // Format the date for display if it exists
        if (periodInput.value) {
            const date = new Date(periodInput.value);
            periodInput.value = date.toISOString().substring(0, 7);
        }

        // Add event listener for when the date changes
        periodInput.addEventListener('change', function() {
            if (this.value) {
                // Ensure the date is in YYYY-MM format
                const date = new Date(this.value + '-01');
                if (!isNaN(date.getTime())) {
                    this.value = date.toISOString().substring(0, 7);
                }
            }
        });
    }

    // Initial LCR preview update
    updateLCRPreview();
});
  </script>
{% endblock %}
